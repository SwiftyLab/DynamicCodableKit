name: "Run Tests with Swift Package"

on:
  workflow_call:

jobs:
  # Test package with swift 5.2 1nd 5.6 on linux
  swift-package:
    name: Run Swift Package Tests with swift version ${{ matrix.swift }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        swift: ['5.2', '5.6']
        # TODO: Enable windows when `swift-actions/setup-swift`
        # supports windows
        # os: [ubuntu-latest, windows-latest]

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Check change in source files
      id: changed_source
      uses: tj-actions/changed-files@v22.2
      with:
        files: |
          Sources/**/*
          Tests/**/*
          Package*.swift
          .github/actions/setup/action.yml
          .github/workflows/swift-package.yml

    - name: Setup repository
      if: steps.changed_source.outputs.any_changed == 'true'
      uses: ./.github/actions/setup
      with:
        swift: ${{ matrix.swift }}

    - name: Run tests
      if: steps.changed_source.outputs.any_changed == 'true'
      run: npm run test

    - name: Swift Coverage Report
      if: |
        steps.changed_source.outputs.any_changed == 'true' &&
        matrix.swift == '5.6' &&
        github.event_name == 'push'
      uses: maxep/spm-lcov-action@0.3.1
      with:
        file-format: lcov
        output-file: ./coverage.lcov

    - name: Codecov upload
      if: |
        steps.changed_source.outputs.any_changed == 'true' &&
        matrix.swift == '5.6' &&
        github.event_name == 'push'
      uses: codecov/codecov-action@v3.1.0
      with:
        token: ${{ secrets.CODECOV_TOKEN }}
        fail_ci_if_error: true
